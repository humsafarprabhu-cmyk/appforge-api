<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{appName}} ‚Äî Admin Panel</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: #0a0a0f; color: #e2e8f0; min-height: 100vh; }
    :root { --primary: #6366f1; --primary-light: #818cf8; --bg: #0a0a0f; --card: rgba(255,255,255,0.04); --border: rgba(255,255,255,0.08); --danger: #ef4444; --success: #22c55e; --warn: #f59e0b; }
    
    /* Layout */
    .admin-layout { display: flex; min-height: 100vh; }
    .sidebar { width: 240px; background: rgba(255,255,255,0.02); border-right: 1px solid var(--border); padding: 24px 16px; flex-shrink: 0; }
    .sidebar h1 { font-size: 18px; margin-bottom: 4px; }
    .sidebar .subtitle { font-size: 12px; opacity: 0.4; margin-bottom: 32px; }
    .sidebar nav a { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; color: inherit; text-decoration: none; font-size: 14px; margin-bottom: 4px; opacity: 0.6; transition: all 0.2s; }
    .sidebar nav a:hover, .sidebar nav a.active { background: var(--card); opacity: 1; }
    .sidebar nav a.active { border-left: 2px solid var(--primary); }
    .main { flex: 1; padding: 32px; max-width: 1200px; }
    
    /* Cards */
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
    .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
    .stat-card .label { font-size: 13px; opacity: 0.5; margin-bottom: 8px; }
    .stat-card .value { font-size: 28px; font-weight: 700; }
    .stat-card .change { font-size: 12px; margin-top: 4px; }
    .stat-card .change.up { color: var(--success); }
    .stat-card .change.down { color: var(--danger); }
    
    /* Tables */
    .table-wrap { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .table-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border); }
    .table-header h2 { font-size: 16px; }
    .search-input { background: rgba(255,255,255,0.06); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; color: white; font-size: 14px; outline: none; width: 240px; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 12px 20px; font-size: 12px; text-transform: uppercase; opacity: 0.4; font-weight: 500; border-bottom: 1px solid var(--border); }
    td { padding: 12px 20px; font-size: 14px; border-bottom: 1px solid var(--border); }
    tr:hover { background: rgba(255,255,255,0.02); }
    
    /* Badges */
    .badge { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 500; }
    .badge-admin { background: rgba(99,102,241,0.15); color: #818cf8; }
    .badge-editor { background: rgba(34,211,238,0.15); color: #22d3ee; }
    .badge-user { background: rgba(255,255,255,0.08); color: #94a3b8; }
    .badge-banned { background: rgba(239,68,68,0.15); color: #f87171; }
    
    /* Buttons */
    .btn { padding: 8px 16px; border-radius: 8px; border: none; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-ghost { background: transparent; color: #94a3b8; border: 1px solid var(--border); }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-sm { padding: 4px 10px; font-size: 12px; }
    
    /* Sections */
    .section { display: none; }
    .section.active { display: block; }
    .section h2 { font-size: 20px; margin-bottom: 20px; }
    
    /* Login */
    .login-wrap { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
    .login-box { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 40px; width: 400px; max-width: 90%; }
    .login-box h2 { text-align: center; margin-bottom: 24px; }
    .form-field { margin-bottom: 16px; }
    .form-field label { display: block; font-size: 13px; opacity: 0.6; margin-bottom: 6px; }
    .form-field input { width: 100%; padding: 10px 14px; background: rgba(255,255,255,0.06); border: 1px solid var(--border); border-radius: 8px; color: white; font-size: 14px; outline: none; }
    .form-field input:focus { border-color: var(--primary); }
    
    /* Notification banner */
    .notif-bar { background: rgba(99,102,241,0.1); border: 1px solid rgba(99,102,241,0.2); border-radius: 8px; padding: 12px 16px; margin-bottom: 24px; display: flex; align-items: center; gap: 8px; font-size: 14px; }
    
    /* Pagination */
    .pagination { display: flex; gap: 8px; padding: 16px 20px; justify-content: center; }
    .pagination button { padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: white; cursor: pointer; font-size: 13px; }
    .pagination button.active { background: var(--primary); border-color: var(--primary); }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login-screen" class="login-wrap">
    <div class="login-box">
      <h2>üîê Admin Panel</h2>
      <p style="text-align:center;opacity:0.5;margin-bottom:24px;font-size:14px;">{{appName}}</p>
      <form id="admin-login-form">
        <div class="form-field">
          <label>Email</label>
          <input type="email" name="email" required placeholder="admin@example.com" />
        </div>
        <div class="form-field">
          <label>Password</label>
          <input type="password" name="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%;padding:12px;margin-top:8px;">Sign In</button>
        <p id="login-error" style="color:#ef4444;text-align:center;margin-top:12px;font-size:13px;display:none;"></p>
      </form>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="admin-dashboard" style="display:none;">
    <div class="admin-layout">
      <div class="sidebar">
        <h1>{{appName}}</h1>
        <div class="subtitle">Admin Panel</div>
        <nav>
          <a href="#" data-section="dashboard" class="active">üìä Dashboard</a>
          <a href="#" data-section="users">üë• Users</a>
          <a href="#" data-section="data">üìÅ Data</a>
          <a href="#" data-section="notifications">üîî Notifications</a>
          <a href="#" data-section="settings">‚öôÔ∏è Settings</a>
        </nav>
        <div style="margin-top:auto;padding-top:32px;">
          <button class="btn btn-ghost" style="width:100%;" onclick="logout()">Sign Out</button>
        </div>
      </div>
      <div class="main">
        <!-- Dashboard Section -->
        <div class="section active" data-section="dashboard">
          <h2>Dashboard</h2>
          <div class="stats" id="stats-grid"></div>
          <div class="table-wrap">
            <div class="table-header">
              <h2>Recent Activity</h2>
            </div>
            <div id="recent-activity" style="padding:20px;text-align:center;opacity:0.4;">Loading...</div>
          </div>
        </div>

        <!-- Users Section -->
        <div class="section" data-section="users">
          <h2>Users</h2>
          <div class="table-wrap">
            <div class="table-header">
              <h2>All Users</h2>
              <input type="text" class="search-input" placeholder="Search users..." id="user-search" />
            </div>
            <table>
              <thead>
                <tr><th>User</th><th>Email</th><th>Role</th><th>Last Login</th><th>Actions</th></tr>
              </thead>
              <tbody id="users-table"></tbody>
            </table>
            <div class="pagination" id="users-pagination"></div>
          </div>
        </div>

        <!-- Data Section -->
        <div class="section" data-section="data">
          <h2>Data Manager</h2>
          <div id="collections-list"></div>
          <div class="table-wrap" style="margin-top:16px;">
            <div class="table-header">
              <h2 id="collection-title">Select a collection</h2>
              <button class="btn btn-primary btn-sm" id="add-item-btn" style="display:none;">+ Add Item</button>
            </div>
            <div id="collection-data" style="padding:20px;text-align:center;opacity:0.4;">Select a collection to view data</div>
          </div>
        </div>

        <!-- Notifications Section -->
        <div class="section" data-section="notifications">
          <h2>Send Notification</h2>
          <div class="table-wrap" style="padding:24px;">
            <form id="notif-form">
              <div class="form-field">
                <label>Title</label>
                <input type="text" name="title" required placeholder="Notification title" />
              </div>
              <div class="form-field">
                <label>Message</label>
                <input type="text" name="body" required placeholder="Notification message" />
              </div>
              <div style="display:flex;gap:12px;">
                <button type="submit" class="btn btn-primary">üì§ Send to All Users</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Settings Section -->
        <div class="section" data-section="settings">
          <h2>Settings</h2>
          <div class="table-wrap" style="padding:24px;">
            <h3 style="margin-bottom:16px;">App Information</h3>
            <p style="opacity:0.5;font-size:14px;">App ID: <code>{{appId}}</code></p>
            <p style="opacity:0.5;font-size:14px;margin-top:8px;">API: <code>{{apiUrl}}</code></p>
            <hr style="border:none;border-top:1px solid var(--border);margin:24px 0;" />
            <h3 style="margin-bottom:16px;color:var(--danger);">Danger Zone</h3>
            <button class="btn btn-danger btn-sm">Delete All Data</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="{{apiUrl}}/runtime/appforge-runtime.js"></script>
  <script>
    var APP_ID = '{{appId}}';
    var API_URL = '{{apiUrl}}';
    
    AF.init({ apiUrl: API_URL, appId: APP_ID });

    // Login
    document.getElementById('admin-login-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      var fd = new FormData(this);
      var errEl = document.getElementById('login-error');
      errEl.style.display = 'none';
      try {
        var user = await AF.auth.login(fd.get('email'), fd.get('password'));
        if (user.role !== 'admin') {
          AF.auth.logout();
          throw new Error('Admin access required');
        }
        showDashboard();
      } catch(err) {
        errEl.textContent = err.message;
        errEl.style.display = 'block';
      }
    });

    // Check existing session
    if (AF.auth.isAdmin) showDashboard();

    function showDashboard() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('admin-dashboard').style.display = 'block';
      loadStats();
      loadUsers();
    }

    function logout() {
      AF.auth.logout();
      document.getElementById('login-screen').style.display = '';
      document.getElementById('admin-dashboard').style.display = 'none';
    }

    // Section navigation
    document.querySelectorAll('[data-section]').forEach(function(el) {
      if (el.tagName === 'A') {
        el.addEventListener('click', function(e) {
          e.preventDefault();
          var section = this.dataset.section;
          document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
          document.querySelector('.section[data-section="' + section + '"]').classList.add('active');
          document.querySelectorAll('nav a').forEach(function(a) { a.classList.remove('active'); });
          this.classList.add('active');
        });
      }
    });

    // Load stats
    async function loadStats() {
      try {
        var stats = await AF.admin.getStats();
        var grid = document.getElementById('stats-grid');
        grid.innerHTML = '';
        
        // Users card
        grid.innerHTML += '<div class="stat-card"><div class="label">Total Users</div><div class="value">' + (stats.users?.total || 0) + '</div><div class="change up">Active: ' + (stats.users?.activeLastWeek || 0) + '</div></div>';
        
        // Collection cards
        if (stats.collections) {
          Object.entries(stats.collections).forEach(function(kv) {
            grid.innerHTML += '<div class="stat-card"><div class="label">' + kv[0] + '</div><div class="value">' + kv[1].count + '</div><div class="change">' + (kv[1].lastUpdated ? 'Updated ' + AF.timeAgo(kv[1].lastUpdated) : 'No data') + '</div></div>';
          });
        }
      } catch(err) {
        console.error('Stats error:', err);
      }
    }

    // Load users
    var userPage = 0;
    async function loadUsers(search) {
      try {
        var result = await AF.admin.listUsers({ limit: 20, offset: userPage * 20, search: search });
        var tbody = document.getElementById('users-table');
        tbody.innerHTML = '';
        
        (result.users || []).forEach(function(u) {
          var roleClass = u.role === 'admin' ? 'badge-admin' : u.role === 'editor' ? 'badge-editor' : 'badge-user';
          var banBtn = u.banned_at
            ? '<button class="btn btn-ghost btn-sm" onclick="unbanUser(\'' + u.id + '\')">Unban</button>'
            : '<button class="btn btn-danger btn-sm" onclick="banUser(\'' + u.id + '\')">Ban</button>';
          
          tbody.innerHTML += '<tr>' +
            '<td><strong>' + (u.display_name || 'Unnamed') + '</strong></td>' +
            '<td>' + u.email + '</td>' +
            '<td><span class="badge ' + roleClass + '">' + u.role + '</span>' + (u.banned_at ? ' <span class="badge badge-banned">Banned</span>' : '') + '</td>' +
            '<td>' + (u.last_login_at ? AF.timeAgo(u.last_login_at) : 'Never') + '</td>' +
            '<td>' + banBtn + ' <select onchange="changeRole(\'' + u.id + '\', this.value)" style="background:transparent;color:white;border:1px solid var(--border);border-radius:4px;padding:2px 4px;font-size:12px;"><option ' + (u.role==='user'?'selected':'') + '>user</option><option ' + (u.role==='editor'?'selected':'') + '>editor</option><option ' + (u.role==='admin'?'selected':'') + '>admin</option></select></td>' +
            '</tr>';
        });
      } catch(err) {
        console.error('Users error:', err);
      }
    }

    async function banUser(id) { await AF.admin.banUser(id); AF.toast('User banned', 'success'); loadUsers(); }
    async function unbanUser(id) { await AF.admin.unbanUser(id); AF.toast('User unbanned', 'success'); loadUsers(); }
    async function changeRole(id, role) { await AF.admin.updateRole(id, role); AF.toast('Role updated', 'success'); loadUsers(); }

    // Search
    var searchTimeout;
    document.getElementById('user-search').addEventListener('input', function() {
      clearTimeout(searchTimeout);
      var val = this.value;
      searchTimeout = setTimeout(function() { loadUsers(val); }, 300);
    });

    // Notifications
    document.getElementById('notif-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      var fd = new FormData(this);
      try {
        await AF.admin.broadcast(fd.get('title'), fd.get('body'));
        AF.toast('Notification sent!', 'success');
        this.reset();
      } catch(err) {
        AF.toast(err.message, 'error');
      }
    });
  </script>
</body>
</html>
